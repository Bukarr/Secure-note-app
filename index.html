<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Secure Note App</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body.dark-mode { background-color: #121212; color: #f1f1f1; }
    .note-card { margin-bottom: 1rem; }
    #drop-zone { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-bottom: 1rem; }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 style="text-align: center;">üîêVaultlify </h2>
  </div>

  <div class="mb-3">
    <input type="password" id="passwordInput" class="form-control" placeholder="Enter password to unlock notes" />
    <button class="btn btn-dark mt-2" onclick="unlockNotes()">Unlock</button>
  </div>

  <div class="mb-3">
    <select id="folderSelect" class="form-select" onchange="renderNotes()">
      <option value="">All Folders</option>
    </select>
    <input type="text" id="newFolderInput" class="form-control mt-2" placeholder="Create new folder" />
    <button class="btn btn-outline-primary mt-2" onclick="createFolder()">Add Folder</button>
  </div>

  <div class="mb-3">
    <textarea id="noteInput" class="form-control" rows="3" placeholder="Write your note..."></textarea>
    <input type="text" id="tagInput" class="form-control mt-2" placeholder="Tags (comma separated)" />
    <div class="mt-2 d-flex gap-2 flex-wrap">
      <button class="btn btn-primary" onclick="saveNote()">Save Note</button>
      <button class="btn btn-info" onclick="startSpeechToText()">üé§ Voice Note</button>
      <button class="btn btn-warning" onclick="document.getElementById('imageInput').click()">üì∑ Scan Image</button>
      <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="scanImage(this)" />
    </div>
  </div>

  <div id="drop-zone" ondrop="handleDrop(event)" ondragover="event.preventDefault()">
    Drag & Drop an image here to scan text
  </div>

  <div id="notesContainer"></div>
</div>

<script>
  let notes = [];
  let folders = JSON.parse(localStorage.getItem('folders')) || [];
  let password = '';
  let editingId = null;

  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
  }

  function createFolder() {
    const folder = document.getElementById('newFolderInput').value.trim();
    if (folder && !folders.includes(folder)) {
      folders.push(folder);
      localStorage.setItem('folders', JSON.stringify(folders));
      updateFolderSelect();
      document.getElementById('newFolderInput').value = '';
    }
  }

  function updateFolderSelect() {
    const select = document.getElementById('folderSelect');
    select.innerHTML = `<option value="">All Folders</option>`;
    folders.forEach(f => {
      const opt = document.createElement('option');
      opt.value = f;
      opt.textContent = f;
      select.appendChild(opt);
    });
  }

  function unlockNotes() {
    password = document.getElementById('passwordInput').value;
    const encrypted = localStorage.getItem('secureNotes');
    if (encrypted) {
      try {
        const decrypted = CryptoJS.AES.decrypt(encrypted, password).toString(CryptoJS.enc.Utf8);
        notes = JSON.parse(decrypted);
        renderNotes();
      } catch {
        alert("Incorrect password or corrupted data.");
      }
    }
    updateFolderSelect();
  }

  function saveNote() {
    const text = document.getElementById('noteInput').value.trim();
    const tags = document.getElementById('tagInput').value.split(',').map(t => t.trim()).filter(Boolean);
    const folder = document.getElementById('folderSelect').value;
    if (!text || !password) return;

    if (editingId) {
      const index = notes.findIndex(n => n.id === editingId);
      notes[index] = { text, tags, folder, id: editingId };
      editingId = null;
    } else {
      notes.push({ text, tags, folder, id: Date.now() });
    }

    const encrypted = CryptoJS.AES.encrypt(JSON.stringify(notes), password).toString();
    localStorage.setItem('secureNotes', encrypted);
    document.getElementById('noteInput').value = '';
    document.getElementById('tagInput').value = '';
    renderNotes();
  }

  function renderNotes() {
    const container = document.getElementById('notesContainer');
    const selectedFolder = document.getElementById('folderSelect').value;
    container.innerHTML = '';

    notes.filter(n => !selectedFolder || n.folder === selectedFolder).forEach(note => {
      const card = document.createElement('div');
      card.className = 'card note-card';
      card.innerHTML = `
        <div class="card-body">
          <p>${note.text}</p>
          <small class="text-muted">Tags: ${note.tags.join(', ')} | Folder: ${note.folder}</small>
          <div class="mt-2 d-flex gap-2 flex-wrap">
            <button class="btn btn-sm btn-danger" onclick="deleteNote(${note.id})">Delete</button>
            <button class="btn btn-sm btn-warning" onclick="editNote(${note.id})">Edit</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="exportNote(${note.id}, 'txt')">TXT</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="exportNote(${note.id}, 'doc')">DOC</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="exportNote(${note.id}, 'pdf')">PDF</button>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function deleteNote(id) {
    notes = notes.filter(n => n.id !== id);
    const encrypted = CryptoJS.AES.encrypt(JSON.stringify(notes), password).toString();
    localStorage.setItem('secureNotes', encrypted);
    renderNotes();
  }

  function editNote(id) {
    const note = notes.find(n => n.id === id);
    document.getElementById('noteInput').value = note.text;
    document.getElementById('tagInput').value = note.tags.join(', ');
    document.getElementById('folderSelect').value = note.folder;
    editingId = id;
  }

  function scanImage(input) {
  const file = input.files[0];
  if (!file) return;

  const img = new Image();
  img.src = URL.createObjectURL(file);
  img.onload = () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    // Resize image to improve OCR accuracy
    const scale = 2; // upscale for better resolution
    canvas.width = img.width * scale;
    canvas.height = img.height * scale;
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    // Convert to grayscale and enhance contrast
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    for (let i = 0; i < imageData.data.length; i += 4) {
      const r = imageData.data[i];
      const g = imageData.data[i + 1];
      const b = imageData.data[i + 2];
      const avg = (r + g + b) / 3;

      // Apply thresholding for contrast
      const threshold = avg > 128 ? 255 : 0;
      imageData.data[i] = imageData.data[i + 1] = imageData.data[i + 2] = threshold;
    }
    ctx.putImageData(imageData, 0, 0);

    // Run OCR with enhanced config
    Tesseract.recognize(canvas.toDataURL(), 'eng', {
      logger: m => console.log(m),
      tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ.,!?()[]{}:;\'"- ',
      preserve_interword_spaces: 1
    }).then(({ data: { text } }) => {
      document.getElementById('noteInput').value = text;
    }).catch(err => {
      console.error('OCR failed:', err);
      alert('OCR failed. Try a clearer image.');
    });
  };
}


  function handleDrop(event) {
    event.preventDefault();
    const file = event.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      scanImage({ files: [file] });
    }
  }

  function startSpeechToText() {
    if (!('webkitSpeechRecognition' in window)) {
      alert("Speech recognition not supported.");
      return;
    }
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'en-US';
    recognition.onresult = e => {
      document.getElementById('noteInput').value += ' ' + e.results[0][0].transcript;
    };
    recognition.start();
  }

  async function exportNote(id, format) {
    const note = notes.find(n => n.id === id);
    const content = `Note:\n${note.text}\n\nTags: ${note.tags.join(', ')}\nFolder: ${note.folder}`;
    if (format === 'txt' || format === 'doc') {
      const blob = new Blob([content], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `note_${id}.${format}`;
      link.click();
    } else if (format === 'pdf') {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text(content, 10, 10);
      doc.save(`note_${id}.pdf`);
    }
    }
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
      .then(() => console.log('Service Worker registered successfully'))
      .catch(error => console.error('Service Worker registration failed:', error));
  }
</script>
</body>
</html>
